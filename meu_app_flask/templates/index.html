<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Presença</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../static/styles.css">

    <!-- Executa o tema antes de renderizar a página -->
    <script>
        // Aplicar o tema imediatamente ao carregar o HTML, antes da renderização
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.classList.add(savedTheme);  // Aplica o tema no root element
            }
        })();
    </script>

</head>
<body>
    <div class="container">
        <div class="menu">
            <form id="siteForm" action="/" method="POST">
                <h2>Filtros de Navegação</h2>
                <label for="site">Selecione o Site:</label>
                <select id="site" name="site">
                    <option value="">-- Escolha um Site --</option>
                    {% for site in sites %}
                        <option value="{{ site }}" {% if site == selected_site %}selected{% endif %}>
                            {{ site }}
                        </option>
                    {% endfor %}
                </select>

                <label for="empresa">Selecione a Empresa:</label>
                <select id="empresa" name="empresa">
                    <option value="">-- Escolha uma Empresa --</option>
                    {% for empresa in empresas %}
                        <option value="{{ empresa }}" {% if empresa == selected_empresa %}selected{% endif %}>
                            {{ empresa }}
                        </option>
                    {% endfor %}
                </select>
            </form>
            <button id="toggle-theme">Alternar Tema</button>
        </div>

        <div class="main-content">
            <h1>Controle de Presença</h1>

            <div class="filtros">
                <form id="filterForm" action="/" method="POST">
                    <input type="hidden" id="hiddenSite" name="site" value="{{ selected_site }}">
                    <input type="hidden" id="hiddenEmpresa" name="empresa" value="{{ selected_empresa }}">
                
                    <div>
                        <label for="nomes">Selecione Nomes:</label>
                        <select id="nomes" name="nomes" multiple="multiple">
                            {% for nome in nomes %}
                                <option value="{{ nome }}" {% if nome in selected_nomes %}selected{% endif %}>
                                    {{ nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <div>
                        <label for="presenca">Selecione o Tipo de Presença:</label>
                        <select id="presenca" name="presenca" multiple="multiple">
                            {% for presenca in presencas %}
                                <option value="{{ presenca }}" {% if presenca in selected_presenca %}selected{% endif %}>
                                    {{ presenca }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                
                    <div>
                        <label for="meses">Selecione o Mês:</label>
                        <select id="meses" name="meses" multiple="multiple">
                            {% for mes in meses %}
                                <option value="{{ mes }}" {% if mes in selected_meses %}selected{% endif %}>
                                    {{ mes }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>

            <div id="table-container">
                {% if data is not none %}
                    <table class="content-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Presença</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for index, row in data.iterrows() %}
                                <tr>
                                    <td>{{ row['Nome'] }}</td>
                                    <td>{{ row['Presenca'] }}</td>
                                    <td>{{ row['Data'] }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>Nenhum dado disponível para o filtro selecionado.</p>
                {% endif %}
            </div>

            <!-- Gráfico de Pizza -->
            <div>
                <h3>Distribuição de Presença</h3>
                <canvas id="pieChart" style="max-width: 400px; max-height: 400px;"></canvas>
            </div>

            <!-- Gráfico de Dispersão -->
            <div>
                <h3>Gráfico de Dispersão (Data x Nomes)</h3>
                <canvas id="scatterChart" style="max-width: 600px; max-height: 400px;"></canvas>
            </div>
            
        </div>
    </div>

    <script>
        $(document).ready(function () {
            $('#nomes').select2({ placeholder: "Escolha um nome" });
            $('#meses').select2({ placeholder: "Escolha um mês" });
            $('#presenca').select2({ placeholder: "Escolha uma presença" });
    
            // Função para submeter o formulário de filtros preservando site e empresa
            function submitWithSiteEmpresa() {
                const site = $('#site').val();
                const empresa = $('#empresa').val();
                $('#hiddenSite').val(site);
                $('#hiddenEmpresa').val(empresa);
                $('#filterForm').submit();
            }
    
            // Evento ao mudar os filtros
            $('#nomes, #meses, #presenca').on('change', function () {
                submitWithSiteEmpresa();
            });
    
            // Evento ao mudar site ou empresa
            $('#site, #empresa').on('change', function () {
                $('#siteForm').submit();
            });
    
            // Alterna o tema e salva no LocalStorage
            $('#toggle-theme').on('click', function () {
                document.body.classList.toggle('dark-mode');
                const currentTheme = document.body.classList.contains('dark-mode')
                    ? 'dark-mode'
                    : 'light-mode';
                localStorage.setItem('theme', currentTheme);
            });
        });

        // Gráfico de Pizza
        var pieChartData = {{ pie_chart_data | safe }};
        var colorMarkerMap = {{ color_marker_map | safe }};
    
        var backgroundColors = pieChartData.labels.map(function(label) {
            if (colorMarkerMap[label]) {
                return colorMarkerMap[label].cor;
            } else {
                return '#999999';
            }
        });

        var ctx = document.getElementById('pieChart').getContext('2d');
        var pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: pieChartData.labels,
                datasets: [{
                    label: 'Distribuição de Presença',
                    data: pieChartData.values,
                    backgroundColor: backgroundColors,
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverOffset: 20
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Distribuição de Presença'
                    }
                }
            }
        });

        // Gráfico de Dispersão
        var scatterChartData = {{ scatter_chart_data | safe }};
        var scatterCtx = document.getElementById('scatterChart').getContext('2d');

        var scatterData = scatterChartData.x.map(function(date, index) {
            return { x: date, y: scatterChartData.y[index], v: scatterChartData.values[index] };
        });

        var scatterChart = new Chart(scatterCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Presença por Data',
                    data: scatterData,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'DD/MM/YYYY'
                        },
                        title: {
                            display: true,
                            text: 'Data'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Nomes'
                        }
                    }
                }
            }
        });
    </script>
    
</body>
</html>
